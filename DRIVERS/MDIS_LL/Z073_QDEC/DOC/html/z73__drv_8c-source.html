<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>MEN - Z73 MDIS Driver - z73_drv.c Source File</title>
<meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<meta name="Language" content="en, english">
<meta name="Copyright" content="All material copyright MEN Mikro Elektronik GmbH">
<link href="men_stylesheet.css" rel="stylesheet" type="text/css">
</head>
<body>

<div class="left_to_right" style="padding-top: 6px; background-color: #F0F0F0; height: 110px; border-bottom: 2px solid #D1D1D2;">
	<!-- Titel -->
	<img src="menlogo.gif" alt="MEN" style="float: left; height: 103px; width: 155px; margin: 0px;">
	<h1 style="margin: 0px; padding-top: 35px; padding-bottom: 0px;">Z73 MDIS Driver &nbsp; </h1>
	<h3>z73_drv.c Source File</h3>
</div>

<div class="left_to_right">
<!-- Hauptteil -->
	<div class="main">
<!-- Generated by Doxygen 1.3.2 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a> | <a class="qindex" href="examples.html">Examples</a></div>
<h1>z73_drv.c</h1><a href="z73__drv_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/*********************  P r o g r a m  -  M o d u l e ***********************/</span>
00018  <span class="comment">/*</span>
00019 <span class="comment"> * This program is free software: you can redistribute it and/or modify</span>
00020 <span class="comment"> * it under the terms of the GNU General Public License as published by</span>
00021 <span class="comment"> * the Free Software Foundation, either version 2 of the License, or</span>
00022 <span class="comment"> * (at your option) any later version.</span>
00023 <span class="comment"> *</span>
00024 <span class="comment"> * This program is distributed in the hope that it will be useful,</span>
00025 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
00026 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
00027 <span class="comment"> * GNU General Public License for more details.</span>
00028 <span class="comment"> *</span>
00029 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
00030 <span class="comment"> * along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
00031 <span class="comment"> */</span>
00032 <span class="preprocessor">#include "<a class="code" href="z73__int_8h.html">z73_int.h</a>"</span>
00033 
00034 <span class="preprocessor">#ifdef Z73_POSCNT_24</span>
00035 <span class="preprocessor"></span><span class="preprocessor">    #ifdef Z73_SW</span>
00036 <span class="preprocessor"></span>        <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> <a class="code" href="z73__drv_8c.html#a0">IdentString</a>[]=MENT_XSTR_SFX(MAK_REVISION,Z73_POSCNT_24 swapped);
00037 <span class="preprocessor">    #else</span>
00038 <span class="preprocessor"></span>        <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> <a class="code" href="z73__drv_8c.html#a0">IdentString</a>[]=MENT_XSTR_SFX(MAK_REVISION,Z73_POSCNT_24 nonswapped);
00039 <span class="preprocessor">    #endif</span>
00040 <span class="preprocessor"></span><span class="preprocessor">#else</span>
00041 <span class="preprocessor"></span><span class="preprocessor">    #ifdef Z73_SW</span>
00042 <span class="preprocessor"></span>        <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> <a class="code" href="z73__drv_8c.html#a0">IdentString</a>[]=MENT_XSTR_SFX(MAK_REVISION,Z73_POSCNT_16 swapped);
00043 <span class="preprocessor">    #else</span>
<a name="l00044"></a><a class="code" href="z73__drv_8c.html#a0">00044</a> <span class="preprocessor"></span>        <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> <a class="code" href="z73__drv_8c.html#a0">IdentString</a>[]=MENT_XSTR_SFX(MAK_REVISION,Z73_POSCNT_16 nonswapped);
00045 <span class="preprocessor">    #endif</span>
00046 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00047 <span class="preprocessor"></span>
00048 <span class="comment">/****************************** Z73_GetEntry ********************************/</span>
<a name="l00053"></a><a class="code" href="z73__drv_8c.html#a1">00053</a> <span class="keyword">extern</span> <span class="keywordtype">void</span> <a class="code" href="z73__drv_8c.html#a1">Z73_GetEntry</a>( LL_ENTRY* drvP )
00054 {
00055     drvP-&gt;init        = <a class="code" href="z73__drv_8c.html#a2">Z73_Init</a>;
00056     drvP-&gt;exit        = <a class="code" href="z73__drv_8c.html#a3">Z73_Exit</a>;
00057     drvP-&gt;read        = <a class="code" href="z73__drv_8c.html#a4">Z73_Read</a>;
00058     drvP-&gt;write       = <a class="code" href="z73__drv_8c.html#a5">Z73_Write</a>;
00059     drvP-&gt;blockRead   = <a class="code" href="z73__drv_8c.html#a8">Z73_BlockRead</a>;
00060     drvP-&gt;blockWrite  = <a class="code" href="z73__drv_8c.html#a9">Z73_BlockWrite</a>;
00061     drvP-&gt;setStat     = <a class="code" href="z73__drv_8c.html#a6">Z73_SetStat</a>;
00062     drvP-&gt;getStat     = <a class="code" href="z73__drv_8c.html#a7">Z73_GetStat</a>;
00063     drvP-&gt;irq         = <a class="code" href="z73__drv_8c.html#a10">Z73_Irq</a>;
00064     drvP-&gt;info        = <a class="code" href="z73__drv_8c.html#a11">Z73_Info</a>;
00065 }
00066 
00067 <span class="comment">/******************************** Z73_Init **********************************/</span>
<a name="l00092"></a><a class="code" href="z73__drv_8c.html#a2">00092</a> <span class="keyword">static</span> int32 <a class="code" href="z73__int_8h.html#a25">Z73_Init</a>(
00093     DESC_SPEC       *descP,
00094     OSS_HANDLE      *osHdl,
00095     MACCESS         *ma,
00096     OSS_SEM_HANDLE  *devSemHdl,
00097     OSS_IRQ_HANDLE  *irqHdl,
00098     <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a>       **llHdlP
00099 )
00100 {
00101     <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl = NULL;
00102     u_int32 gotsize;
00103     int32 error;
00104     u_int32 value;
00105 
00106     <span class="comment">/*------------------------------+</span>
00107 <span class="comment">    |  prepare the handle           |</span>
00108 <span class="comment">    +------------------------------*/</span>
00109     *llHdlP = NULL;     <span class="comment">/* set low-level driver handle to NULL */</span>
00110 
00111     <span class="comment">/* alloc */</span>
00112     <span class="keywordflow">if</span> ((llHdl = (<a class="code" href="structLL__HANDLE.html">LL_HANDLE</a>*)OSS_MemGet(
00113                     osHdl, <span class="keyword">sizeof</span>(<a class="code" href="structLL__HANDLE.html">LL_HANDLE</a>), &amp;gotsize)) == NULL)
00114        <span class="keywordflow">return</span>(ERR_OSS_MEM_ALLOC);
00115 
00116     <span class="comment">/* clear */</span>
00117     OSS_MemFill(osHdl, gotsize, (<span class="keywordtype">char</span>*)llHdl, 0x00);
00118 
00119     <span class="comment">/* init */</span>
00120     llHdl-&gt;memAlloc   = gotsize;
00121     llHdl-&gt;osHdl      = osHdl;
00122     llHdl-&gt;irqHdl     = irqHdl;
00123     llHdl-&gt;ma         = *ma;
00124 
00125     <span class="comment">/*------------------------------+</span>
00126 <span class="comment">    |  init id function table       |</span>
00127 <span class="comment">    +------------------------------*/</span>
00128     <span class="comment">/* driver's ident function */</span>
00129     llHdl-&gt;idFuncTbl.idCall[0].identCall = <a class="code" href="z73__drv_8c.html#a12">Ident</a>;
00130     <span class="comment">/* library's ident functions */</span>
00131     llHdl-&gt;idFuncTbl.idCall[1].identCall = DESC_Ident;
00132     llHdl-&gt;idFuncTbl.idCall[2].identCall = OSS_Ident;
00133     <span class="comment">/* terminator */</span>
00134     llHdl-&gt;idFuncTbl.idCall[3].identCall = NULL;
00135 
00136     <span class="comment">/*------------------------------+</span>
00137 <span class="comment">    |  prepare debugging            |</span>
00138 <span class="comment">    +------------------------------*/</span>
00139     <a class="code" href="z73__int_8h.html#a6">DBG_MYLEVEL</a> = OSS_DBG_DEFAULT;  <span class="comment">/* set OS specific debug level */</span>
00140     DBGINIT((NULL,&amp;<a class="code" href="z73__int_8h.html#a7">DBH</a>));
00141 
00142     <span class="comment">/*------------------------------+</span>
00143 <span class="comment">    |  scan descriptor              |</span>
00144 <span class="comment">    +------------------------------*/</span>
00145     <span class="comment">/* prepare access */</span>
00146     <span class="keywordflow">if</span> ((error = DESC_Init(descP, osHdl, &amp;llHdl-&gt;descHdl)))
00147         <span class="keywordflow">return</span>( <a class="code" href="z73__int_8h.html#a36">Cleanup</a>(llHdl,error) );
00148 
00149     <span class="comment">/* DEBUG_LEVEL_DESC */</span>
00150     <span class="keywordflow">if</span> ((error = DESC_GetUInt32(llHdl-&gt;descHdl, OSS_DBG_DEFAULT,
00151                                 &amp;value, <span class="stringliteral">"DEBUG_LEVEL_DESC"</span>)) &amp;&amp;
00152         error != ERR_DESC_KEY_NOTFOUND)
00153         <span class="keywordflow">return</span>( <a class="code" href="z73__int_8h.html#a36">Cleanup</a>(llHdl,error) );
00154 
00155     DESC_DbgLevelSet(llHdl-&gt;descHdl, value);    <span class="comment">/* set level */</span>
00156 
00157     <span class="comment">/* DEBUG_LEVEL */</span>
00158     <span class="keywordflow">if</span> ((error = DESC_GetUInt32(llHdl-&gt;descHdl, OSS_DBG_DEFAULT,
00159                                 &amp;llHdl-&gt;dbgLevel, <span class="stringliteral">"DEBUG_LEVEL"</span>)) &amp;&amp;
00160         error != ERR_DESC_KEY_NOTFOUND)
00161         <span class="keywordflow">return</span>( <a class="code" href="z73__int_8h.html#a36">Cleanup</a>(llHdl,error) );
00162 
00163     <span class="keywordflow">if</span> ((error = DESC_GetUInt32(llHdl-&gt;descHdl, 0,
00164                                 &amp;value, <span class="stringliteral">"Z073_INT_PRS"</span>)) &amp;&amp;
00165         error != ERR_DESC_KEY_NOTFOUND)
00166         <span class="keywordflow">return</span>( <a class="code" href="z73__int_8h.html#a36">Cleanup</a>(llHdl,error) );
00167 
00168     llHdl-&gt;irqEn |= (value ? <a class="code" href="z73__int_8h.html#a14">Z073_IRQ_EN_PRS</a> : 0);
00169 
00170     <span class="keywordflow">if</span> ((error = DESC_GetUInt32(llHdl-&gt;descHdl, 0,
00171                                 &amp;value, <span class="stringliteral">"Z073_INT_REL"</span>)) &amp;&amp;
00172         error != ERR_DESC_KEY_NOTFOUND)
00173         <span class="keywordflow">return</span>( <a class="code" href="z73__int_8h.html#a36">Cleanup</a>(llHdl,error) );
00174 
00175     llHdl-&gt;irqEn |= (value ? <a class="code" href="z73__int_8h.html#a13">Z073_IRQ_EN_REL</a> : 0);
00176 
00177     <span class="keywordflow">if</span> ((error = DESC_GetUInt32(llHdl-&gt;descHdl, 0,
00178                                 &amp;value, <span class="stringliteral">"Z073_INT_UP"</span>)) &amp;&amp;
00179         error != ERR_DESC_KEY_NOTFOUND)
00180         <span class="keywordflow">return</span>( <a class="code" href="z73__int_8h.html#a36">Cleanup</a>(llHdl,error) );
00181 
00182     llHdl-&gt;irqEn |= (value ? <a class="code" href="z73__int_8h.html#a16">Z073_IRQ_EN_UP</a> : 0);
00183 
00184     <span class="keywordflow">if</span> ((error = DESC_GetUInt32(llHdl-&gt;descHdl, 0,
00185                                 &amp;value, <span class="stringliteral">"Z073_INT_DWN"</span>)) &amp;&amp;
00186         error != ERR_DESC_KEY_NOTFOUND)
00187         <span class="keywordflow">return</span>( <a class="code" href="z73__int_8h.html#a36">Cleanup</a>(llHdl,error) );
00188 
00189     llHdl-&gt;irqEn |= (value ? <a class="code" href="z73__int_8h.html#a15">Z073_IRQ_EN_DWN</a> : 0);
00190 
00191     <span class="keywordflow">if</span> ((error = DESC_GetUInt32(llHdl-&gt;descHdl, 10,
00192                                 &amp;value, <span class="stringliteral">"Z073_STATUSQ_SIZE"</span>)) &amp;&amp;
00193         error != ERR_DESC_KEY_NOTFOUND)
00194         <span class="keywordflow">return</span>( <a class="code" href="z73__int_8h.html#a36">Cleanup</a>(llHdl,error) );
00195 
00196     llHdl-&gt;statusQDepth  = (value &gt; 1) ? value : <a class="code" href="z73__int_8h.html#a5">Z073_STATUSQ_SIZE_DEF</a>;
00197 
00198     DBGWRT_1((<a class="code" href="z73__int_8h.html#a7">DBH</a>, <span class="stringliteral">"LL - Z73_Init base addr = 0x%08x\n"</span>, llHdl-&gt;ma));
00199 
00200 
00201 
00202     <span class="comment">/*------------------------------+</span>
00203 <span class="comment">    |  init status queue            |</span>
00204 <span class="comment">    +------------------------------*/</span>
00205 
00206     <span class="keywordflow">if</span> ((llHdl-&gt;statusQ = (u_int32 *)OSS_MemGet(
00207                     osHdl, 4*llHdl-&gt;statusQDepth, &amp;gotsize)) == NULL)
00208     {
00209         error = ERR_OSS_MEM_ALLOC;
00210         <span class="keywordflow">return</span>( <a class="code" href="z73__int_8h.html#a36">Cleanup</a>(llHdl,error) );
00211     }
00212     llHdl-&gt;statusQSizeGot = gotsize;
00213     DBGWRT_1((<a class="code" href="z73__int_8h.html#a7">DBH</a>, <span class="stringliteral">"LL - Z73_Init statusQ=0x%08x size=%d\n"</span>,
00214             (u_int32 *)llHdl-&gt;statusQ, (<span class="keywordtype">int</span>)llHdl-&gt;statusQSizeGot));
00215 
00216     <span class="comment">/* clear */</span>
00217     OSS_MemFill(osHdl, gotsize, (<span class="keywordtype">char</span>*)llHdl-&gt;statusQ, 0x00);
00218 
00219     <span class="comment">/*------------------------------+</span>
00220 <span class="comment">    |  init hardware                |</span>
00221 <span class="comment">    +------------------------------*/</span>
00222     <span class="comment">/* clear and enable interrupts and position status */</span>
00223     MWRITE_D32( ma, <a class="code" href="z73__int_8h.html#a11">Z073_IRQ_EN</a>, 0x00 );
00224     MREAD_D32( ma, <a class="code" href="z73__int_8h.html#a8">Z073_POS_CNT</a> );
00225     MWRITE_D32( ma, <a class="code" href="z73__int_8h.html#a17">Z073_IRQ</a>, 0xFFFFFFFF );
00226 
00227     *llHdlP = llHdl;    <span class="comment">/* set low-level driver handle */</span>
00228 
00229     <span class="keywordflow">return</span>(ERR_SUCCESS);
00230 }
00231 
00232 <span class="comment">/****************************** Z73_Exit ************************************/</span>
<a name="l00242"></a><a class="code" href="z73__drv_8c.html#a3">00242</a> <span class="keyword">static</span> int32 <a class="code" href="z73__int_8h.html#a26">Z73_Exit</a>(
00243    <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a>    **llHdlP
00244 )
00245 {
00246     <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl = *llHdlP;
00247     int32 error = 0;
00248 
00249     DBGWRT_1((<a class="code" href="z73__int_8h.html#a7">DBH</a>, <span class="stringliteral">"LL - Z73_Exit\n"</span>));
00250 
00251     <span class="comment">/*------------------------------+</span>
00252 <span class="comment">    |  de-init hardware             |</span>
00253 <span class="comment">    +------------------------------*/</span>
00254     <span class="comment">/* disable interrupts */</span>
00255     MWRITE_D32( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o4">ma</a>, <a class="code" href="z73__int_8h.html#a11">Z073_IRQ_EN</a>, 0x00 );
00256 
00257     <span class="comment">/*------------------------------+</span>
00258 <span class="comment">    |  clean up memory              |</span>
00259 <span class="comment">    +------------------------------*/</span>
00260     *llHdlP = NULL;     <span class="comment">/* set low-level driver handle to NULL */</span>
00261     error = <a class="code" href="z73__int_8h.html#a36">Cleanup</a>(llHdl,error);
00262 
00263     <span class="keywordflow">return</span>(error);
00264 }
00265 
00266 <span class="comment">/****************************** Z73_Read ************************************/</span>
<a name="l00271"></a><a class="code" href="z73__drv_8c.html#a4">00271</a> <span class="keyword">static</span> int32 <a class="code" href="z73__int_8h.html#a27">Z73_Read</a>(
00272     <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl,
00273     int32 ch,
00274     int32 *valueP
00275 )
00276 {
00277     <span class="keywordflow">return</span>(ERR_LL_ILL_FUNC);
00278 }
00279 
00280 <span class="comment">/****************************** Z73_Write ***********************************/</span>
<a name="l00285"></a><a class="code" href="z73__drv_8c.html#a5">00285</a> <span class="keyword">static</span> int32 <a class="code" href="z73__int_8h.html#a28">Z73_Write</a>(
00286     <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl,
00287     int32 ch,
00288     int32 value
00289 )
00290 {
00291     <span class="keywordflow">return</span>(ERR_LL_ILL_FUNC);
00292 }
00293 
00294 <span class="comment">/****************************** Z73_SetStat *********************************/</span>
<a name="l00308"></a><a class="code" href="z73__drv_8c.html#a6">00308</a> <span class="keyword">static</span> int32 <a class="code" href="z73__int_8h.html#a29">Z73_SetStat</a>(
00309     <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl,
00310     int32  code,
00311     int32  ch,
00312     INT32_OR_64 value32_or_64
00313 )
00314 {
00315     int32 value = (int32)value32_or_64;     <span class="comment">/* 32bit value */</span>
00316     <span class="comment">/* INT32_OR_64 valueP = value32_or_64;    stores 32/64bit pointer */</span>
00317     int32 error = ERR_SUCCESS;
00318 
00319     DBGWRT_1((<a class="code" href="z73__int_8h.html#a7">DBH</a>, <span class="stringliteral">"LL - Z73_SetStat: ch=%d code=0x%04x value=0x%x\n"</span>,
00320               ch,code,value));
00321 
00322     <span class="keywordflow">switch</span>(code)
00323     {
00324         <span class="comment">/*--------------------------+</span>
00325 <span class="comment">        |  debug level              |</span>
00326 <span class="comment">        +--------------------------*/</span>
00327         <span class="keywordflow">case</span> M_LL_DEBUG_LEVEL:
00328             llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o6">dbgLevel</a> = value;
00329             <span class="keywordflow">break</span>;
00330         <span class="comment">/*--------------------------+</span>
00331 <span class="comment">        |  enable interrupts        |</span>
00332 <span class="comment">        +--------------------------*/</span>
00333         <span class="keywordflow">case</span> M_MK_IRQ_ENABLE:
00334             <span class="keywordflow">if</span>( value ) <span class="comment">/* enable interrupts ?*/</span>
00335             {
00336                 MREAD_D32( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o4">ma</a>, <a class="code" href="z73__int_8h.html#a8">Z073_POS_CNT</a> );
00337                 MWRITE_D32( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o4">ma</a>, <a class="code" href="z73__int_8h.html#a17">Z073_IRQ</a>, 0xFFFFFFFF );
00338                 MWRITE_D32( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o4">ma</a>, <a class="code" href="z73__int_8h.html#a11">Z073_IRQ_EN</a>, llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o9">irqEn</a> );
00339             } <span class="keywordflow">else</span>       <span class="comment">/* disable interrupts */</span>
00340             {
00341                 MWRITE_D32( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o4">ma</a>, <a class="code" href="z73__int_8h.html#a11">Z073_IRQ_EN</a>, 0 );
00342             }
00343             <span class="keywordflow">break</span>;
00344         <span class="comment">/*--------------------------+</span>
00345 <span class="comment">        |  set irq counter          |</span>
00346 <span class="comment">        +--------------------------*/</span>
00347         <span class="keywordflow">case</span> M_LL_IRQ_COUNT:
00348             llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o8">irqCount</a> = value;
00349             <span class="keywordflow">break</span>;
00350         <span class="comment">/*--------------------------+</span>
00351 <span class="comment">        |  channel direction        |</span>
00352 <span class="comment">        +--------------------------*/</span>
00353         <span class="keywordflow">case</span> M_LL_CH_DIR:
00354             <span class="keywordflow">if</span>( value != M_CH_OUT )
00355                 error = ERR_LL_ILL_DIR;
00356             <span class="keywordflow">break</span>;
00357         <span class="keywordflow">case</span> Z073_SIG_PRS_REL:
00358             <span class="keywordflow">if</span>( value ) <span class="comment">/* install signal */</span>
00359             {   <span class="comment">/* signal already installed ? */</span>
00360                 <span class="keywordflow">if</span>( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o10">prsRelSig</a> ) {
00361                     error = ERR_OSS_SIG_SET;
00362                     <span class="keywordflow">break</span>;
00363                 }
00364 
00365                 error = OSS_SigCreate( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o1">osHdl</a>, value, &amp;llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o10">prsRelSig</a> );
00366             } <span class="keywordflow">else</span> <span class="comment">/* clear signal */</span>
00367             {
00368                 <span class="comment">/* signal already installed ? */</span>
00369                 <span class="keywordflow">if</span>( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o10">prsRelSig</a> == NULL ) {
00370                     error = ERR_OSS_SIG_CLR;
00371                     <span class="keywordflow">break</span>;
00372                 }
00373 
00374                 error = OSS_SigRemove( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o1">osHdl</a>, &amp;llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o10">prsRelSig</a> );
00375             }
00376             <span class="keywordflow">break</span>;
00377         <span class="keywordflow">case</span> Z073_SIG_MOVE:
00378             <span class="keywordflow">if</span>( value ) <span class="comment">/* install signal */</span>
00379             {   <span class="comment">/* signal already installed ? */</span>
00380                 <span class="keywordflow">if</span>( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o11">upDwnSig</a> ) {
00381                     error = ERR_OSS_SIG_SET;
00382                     <span class="keywordflow">break</span>;
00383                 }
00384 
00385                 error = OSS_SigCreate( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o1">osHdl</a>, value, &amp;llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o11">upDwnSig</a> );
00386             } <span class="keywordflow">else</span> <span class="comment">/* clear signal */</span>
00387             {
00388                 <span class="comment">/* signal already installed ? */</span>
00389                 <span class="keywordflow">if</span>( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o11">upDwnSig</a> == NULL ) {
00390                     error = ERR_OSS_SIG_CLR;
00391                     <span class="keywordflow">break</span>;
00392                 }
00393 
00394                 error = OSS_SigRemove( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o1">osHdl</a>, &amp;llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o11">upDwnSig</a> );
00395             }
00396             <span class="keywordflow">break</span>;
00397         <span class="keywordflow">case</span> Z073_INT_PRS:
00398             <span class="keywordflow">if</span>( value &amp;&amp; !(llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o9">irqEn</a> &amp; <a class="code" href="z73__int_8h.html#a14">Z073_IRQ_EN_PRS</a>) )
00399             {  <span class="comment">/* enable interrupt */</span>
00400                 llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o9">irqEn</a> |= <a class="code" href="z73__int_8h.html#a14">Z073_IRQ_EN_PRS</a>;
00401                 <span class="keywordflow">if</span>( (MREAD_D32( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o4">ma</a>, <a class="code" href="z73__int_8h.html#a11">Z073_IRQ_EN</a> ) &amp; <a class="code" href="z73__int_8h.html#a12">Z073_IRQ_EN_ALL</a>) )
00402                 { <span class="comment">/* only enable irqs if already enabled */</span>
00403                     MWRITE_D32( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o4">ma</a>, <a class="code" href="z73__int_8h.html#a17">Z073_IRQ</a>, <a class="code" href="z73__int_8h.html#a22">Z073_IRQ_PRS</a> );
00404                     MWRITE_D32( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o4">ma</a>, <a class="code" href="z73__int_8h.html#a11">Z073_IRQ_EN</a>, llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o9">irqEn</a> );
00405                 }
00406             } <span class="keywordflow">else</span> <span class="keywordflow">if</span>( !value )  <span class="comment">/* disable interrupt */</span>
00407             {
00408                 llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o9">irqEn</a> &amp;= ~<a class="code" href="z73__int_8h.html#a14">Z073_IRQ_EN_PRS</a>;
00409                 MWRITE_D32( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o4">ma</a>, <a class="code" href="z73__int_8h.html#a11">Z073_IRQ_EN</a>, llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o9">irqEn</a> );
00410             }
00411             <span class="keywordflow">break</span>;
00412         <span class="keywordflow">case</span> Z073_INT_REL:
00413             <span class="keywordflow">if</span>( value &amp;&amp; !(llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o9">irqEn</a> &amp; <a class="code" href="z73__int_8h.html#a13">Z073_IRQ_EN_REL</a>) )
00414             {  <span class="comment">/* enable interrupt */</span>
00415                 llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o9">irqEn</a> |= <a class="code" href="z73__int_8h.html#a13">Z073_IRQ_EN_REL</a>;
00416                 <span class="keywordflow">if</span>( (MREAD_D32( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o4">ma</a>, <a class="code" href="z73__int_8h.html#a11">Z073_IRQ_EN</a> ) &amp; <a class="code" href="z73__int_8h.html#a12">Z073_IRQ_EN_ALL</a>) )
00417                 { <span class="comment">/* only enable irqs if already enabled */</span>
00418                     MWRITE_D32( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o4">ma</a>, <a class="code" href="z73__int_8h.html#a17">Z073_IRQ</a>, <a class="code" href="z73__int_8h.html#a21">Z073_IRQ_REL</a> );
00419                     MWRITE_D32( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o4">ma</a>, <a class="code" href="z73__int_8h.html#a11">Z073_IRQ_EN</a>, llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o9">irqEn</a> );
00420                 }
00421             } <span class="keywordflow">else</span> <span class="keywordflow">if</span>( !value )  <span class="comment">/* disable interrupt */</span>
00422             {
00423                 llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o9">irqEn</a> &amp;= ~<a class="code" href="z73__int_8h.html#a13">Z073_IRQ_EN_REL</a>;
00424                 MWRITE_D32( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o4">ma</a>, <a class="code" href="z73__int_8h.html#a11">Z073_IRQ_EN</a>, llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o9">irqEn</a> );
00425             }
00426             <span class="keywordflow">break</span>;
00427         <span class="keywordflow">case</span> Z073_INT_UP:
00428             <span class="keywordflow">if</span>( value &amp;&amp; !(llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o9">irqEn</a> &amp; <a class="code" href="z73__int_8h.html#a16">Z073_IRQ_EN_UP</a>) )
00429             {  <span class="comment">/* enable interrupt */</span>
00430                 llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o9">irqEn</a> |= <a class="code" href="z73__int_8h.html#a16">Z073_IRQ_EN_UP</a>;
00431                 <span class="keywordflow">if</span>( (MREAD_D32( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o4">ma</a>, <a class="code" href="z73__int_8h.html#a11">Z073_IRQ_EN</a> ) &amp; <a class="code" href="z73__int_8h.html#a12">Z073_IRQ_EN_ALL</a>) )
00432                 { <span class="comment">/* only enable irqs if already enabled */</span>
00433                     MWRITE_D32( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o4">ma</a>, <a class="code" href="z73__int_8h.html#a17">Z073_IRQ</a>, <a class="code" href="z73__int_8h.html#a24">Z073_IRQ_UP</a> );
00434                     MWRITE_D32( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o4">ma</a>, <a class="code" href="z73__int_8h.html#a11">Z073_IRQ_EN</a>, llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o9">irqEn</a> );
00435                 }
00436             } <span class="keywordflow">else</span> <span class="keywordflow">if</span>( !value )  <span class="comment">/* disable interrupt */</span>
00437             {
00438                 llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o9">irqEn</a> &amp;= ~<a class="code" href="z73__int_8h.html#a16">Z073_IRQ_EN_UP</a>;
00439                 MWRITE_D32( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o4">ma</a>, <a class="code" href="z73__int_8h.html#a11">Z073_IRQ_EN</a>, llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o9">irqEn</a> );
00440             }
00441             <span class="keywordflow">break</span>;
00442         <span class="keywordflow">case</span> Z073_INT_DWN:
00443             <span class="keywordflow">if</span>( value &amp;&amp; !(llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o9">irqEn</a> &amp; <a class="code" href="z73__int_8h.html#a15">Z073_IRQ_EN_DWN</a>) )
00444             {  <span class="comment">/* enable interrupt */</span>
00445                 llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o9">irqEn</a> |= <a class="code" href="z73__int_8h.html#a15">Z073_IRQ_EN_DWN</a>;
00446                 <span class="keywordflow">if</span>( (MREAD_D32( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o4">ma</a>, <a class="code" href="z73__int_8h.html#a11">Z073_IRQ_EN</a> ) &amp; <a class="code" href="z73__int_8h.html#a12">Z073_IRQ_EN_ALL</a>) )
00447                 { <span class="comment">/* only enable irqs if already enabled */</span>
00448                     MWRITE_D32( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o4">ma</a>, <a class="code" href="z73__int_8h.html#a17">Z073_IRQ</a>, <a class="code" href="z73__int_8h.html#a23">Z073_IRQ_DWN</a> );
00449                     MWRITE_D32( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o4">ma</a>, <a class="code" href="z73__int_8h.html#a11">Z073_IRQ_EN</a>, llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o9">irqEn</a> );
00450                 }
00451             } <span class="keywordflow">else</span> <span class="keywordflow">if</span>( !value )  <span class="comment">/* disable interrupt */</span>
00452             {
00453                 llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o9">irqEn</a> &amp;= ~<a class="code" href="z73__int_8h.html#a15">Z073_IRQ_EN_DWN</a>;
00454                 MWRITE_D32( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o4">ma</a>, <a class="code" href="z73__int_8h.html#a11">Z073_IRQ_EN</a>, llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o9">irqEn</a> );
00455             }
00456             <span class="keywordflow">break</span>;
00457        <span class="comment">/*--------------------------+</span>
00458 <span class="comment">        |  (unknown)                |</span>
00459 <span class="comment">        +--------------------------*/</span>
00460         <span class="keywordflow">default</span>:
00461             error = ERR_LL_UNK_CODE;
00462     }
00463 
00464     <span class="keywordflow">return</span>(error);
00465 }
00466 
00467 <span class="comment">/****************************** Z73_GetStat *********************************/</span>
<a name="l00483"></a><a class="code" href="z73__drv_8c.html#a7">00483</a> <span class="keyword">static</span> int32 <a class="code" href="z73__int_8h.html#a30">Z73_GetStat</a>(
00484     <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl,
00485     int32  code,
00486     int32  ch,
00487     INT32_OR_64 *value32_or_64P
00488 )
00489 {
00490     <span class="comment">/* pointer to 32bit value  */</span>
00491     int32       *valueP       = (int32*)value32_or_64P;
00492     <span class="comment">/* stores 32/64bit pointer  */</span>
00493     INT32_OR_64 *value64P     = value32_or_64P;
00494     <span class="comment">/*   stores block struct pointer */</span>
00495     <span class="comment">/* M_SG_BLOCK   *blk          = (M_SG_BLOCK*)value32_or_64P;*/</span>
00496     int32 error = ERR_SUCCESS;
00497 
00498     DBGWRT_1((<a class="code" href="z73__int_8h.html#a7">DBH</a>, <span class="stringliteral">"LL - Z73_GetStat: ch=%d code=0x%04x\n"</span>,
00499               ch,code));
00500 
00501     <span class="keywordflow">switch</span>(code)
00502     {
00503         <span class="comment">/*--------------------------+</span>
00504 <span class="comment">        |  debug level              |</span>
00505 <span class="comment">        +--------------------------*/</span>
00506         <span class="keywordflow">case</span> M_LL_DEBUG_LEVEL:
00507             *valueP = llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o6">dbgLevel</a>;
00508             <span class="keywordflow">break</span>;
00509         <span class="comment">/*--------------------------+</span>
00510 <span class="comment">        |  number of channels       |</span>
00511 <span class="comment">        +--------------------------*/</span>
00512         <span class="keywordflow">case</span> M_LL_CH_NUMBER:
00513             *valueP = <a class="code" href="z73__int_8h.html#a1">CH_NUMBER</a>;
00514             <span class="keywordflow">break</span>;
00515         <span class="comment">/*--------------------------+</span>
00516 <span class="comment">        |  channel direction        |</span>
00517 <span class="comment">        +--------------------------*/</span>
00518         <span class="keywordflow">case</span> M_LL_CH_DIR:
00519             *valueP = M_CH_OUT;
00520             <span class="keywordflow">break</span>;
00521         <span class="comment">/*--------------------------+</span>
00522 <span class="comment">        |  channel length [bits]    |</span>
00523 <span class="comment">        +--------------------------*/</span>
00524         <span class="keywordflow">case</span> M_LL_CH_LEN:
00525             *valueP = 32;
00526             <span class="keywordflow">break</span>;
00527         <span class="comment">/*--------------------------+</span>
00528 <span class="comment">        |  channel type info        |</span>
00529 <span class="comment">        +--------------------------*/</span>
00530         <span class="keywordflow">case</span> M_LL_CH_TYP:
00531             *valueP = M_CH_BINARY;
00532             <span class="keywordflow">break</span>;
00533         <span class="comment">/*--------------------------+</span>
00534 <span class="comment">        |  irq counter              |</span>
00535 <span class="comment">        +--------------------------*/</span>
00536         <span class="keywordflow">case</span> M_LL_IRQ_COUNT:
00537             *valueP = llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o8">irqCount</a>;
00538             <span class="keywordflow">break</span>;
00539         <span class="comment">/*--------------------------+</span>
00540 <span class="comment">        |   ident table pointer     |</span>
00541 <span class="comment">        |   (treat as non-block!)   |</span>
00542 <span class="comment">        +--------------------------*/</span>
00543         <span class="keywordflow">case</span> M_MK_BLK_REV_ID:
00544             *value64P = (INT32_OR_64)&amp;llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o5">idFuncTbl</a>;
00545             <span class="keywordflow">break</span>;
00546         <span class="comment">/*--------------------------+</span>
00547 <span class="comment">        |   get status              |</span>
00548 <span class="comment">        +--------------------------*/</span>
00549         <span class="keywordflow">case</span> Z073_STATUS:
00550         {
00551             OSS_IRQ_STATE irqState;
00552             *valueP = 0; <span class="comment">/* in case off error return value might be parsed */</span>
00553 
00554             <span class="keywordflow">if</span>( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o17">error</a> ) <span class="comment">/* errors have higher priority than data */</span>
00555             {
00556                 error = llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o17">error</a>;
00557                 llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o17">error</a> = 0;
00558                 DBGWRT_ERR((<a class="code" href="z73__int_8h.html#a7">DBH</a>, <span class="stringliteral">"*** LL - Z73_GetStat(STATUS): 0x%04x\n"</span>, error));
00559                 <span class="keywordflow">break</span>;
00560             }
00561 
00562             <span class="keywordflow">if</span>( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o13">statusQIn</a> == llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o14">statusQOut</a> ) <span class="comment">/* empty queue */</span>
00563             {
00564                 irqState = OSS_IrqMaskR( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o1">osHdl</a>, llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o2">irqHdl</a> );
00565                 error  = <a class="code" href="z73__int_8h.html#a37">getStatus</a>( llHdl );
00566                 OSS_IrqRestore( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o1">osHdl</a>, llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o2">irqHdl</a>, irqState );
00567 
00568                 <span class="keywordflow">if</span>( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o13">statusQIn</a> == llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o14">statusQOut</a> ) <span class="comment">/* still empty */</span>
00569                 {
00570                     error = Z073_ERR_NO_STATUS;
00571                     DBGWRT_3((<a class="code" href="z73__int_8h.html#a7">DBH</a>, <span class="stringliteral">"LL - Z73_GetStat(STATUS): no new events\n"</span>, error));
00572                     <span class="keywordflow">break</span>;
00573                 }
00574             }
00575 
00576             *valueP = (int32)llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o12">statusQ</a>[llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o14">statusQOut</a>++];
00577 
00578             <span class="keywordflow">if</span>( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o14">statusQOut</a> == llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o15">statusQDepth</a> )
00579                 llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o14">statusQOut</a> = 0;
00580 
00581 
00582             <span class="keywordflow">break</span>;
00583         }
00584         <span class="comment">/*--------------------------+</span>
00585 <span class="comment">        |  (unknown)                |</span>
00586 <span class="comment">        +--------------------------*/</span>
00587         <span class="keywordflow">default</span>:
00588             error = ERR_LL_UNK_CODE;
00589     }
00590 
00591     <span class="keywordflow">return</span>(error);
00592 }
00593 
00594 <span class="comment">/******************************* Z73_BlockRead ******************************/</span>
<a name="l00599"></a><a class="code" href="z73__drv_8c.html#a8">00599</a> <span class="keyword">static</span> int32 <a class="code" href="z73__int_8h.html#a31">Z73_BlockRead</a>(
00600      <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl,
00601      int32     ch,
00602      <span class="keywordtype">void</span>      *buf,
00603      int32     size,
00604      int32     *nbrRdBytesP
00605 )
00606 {
00607     DBGWRT_1((<a class="code" href="z73__int_8h.html#a7">DBH</a>, <span class="stringliteral">"LL - Z73_BlockRead: not supported \n"</span>));
00608 
00609     <span class="comment">/* return number of read bytes */</span>
00610     *nbrRdBytesP = 0;
00611 
00612     <span class="keywordflow">return</span>(ERR_LL_ILL_FUNC);
00613 }
00614 
00615 <span class="comment">/****************************** Z73_BlockWrite *****************************/</span>
<a name="l00620"></a><a class="code" href="z73__drv_8c.html#a9">00620</a> <span class="keyword">static</span> int32 <a class="code" href="z73__int_8h.html#a32">Z73_BlockWrite</a>(
00621      <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl,
00622      int32     ch,
00623      <span class="keywordtype">void</span>      *buf,
00624      int32     size,
00625      int32     *nbrWrBytesP
00626 )
00627 {
00628     <span class="comment">/* return number of written bytes */</span>
00629     *nbrWrBytesP = 0;
00630 
00631     <span class="keywordflow">return</span>(ERR_LL_ILL_FUNC);
00632 }
00633 
00634 
00635 <span class="comment">/****************************** Z73_Irq ************************************/</span>
<a name="l00648"></a><a class="code" href="z73__drv_8c.html#a10">00648</a> <span class="keyword">static</span> int32 <a class="code" href="z73__int_8h.html#a33">Z73_Irq</a>(
00649    <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a> *llHdl
00650 )
00651 {
00652     u_int32 irqReg = 0;
00653     int32 getStatusError = ERR_SUCCESS;
00654 
00655     IDBGWRT_1((<a class="code" href="z73__int_8h.html#a7">DBH</a>, <span class="stringliteral">"&gt;&gt;&gt; Z73_Irq\n"</span>));
00656 
00657     irqReg = MREAD_D32( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o4">ma</a>, <a class="code" href="z73__int_8h.html#a17">Z073_IRQ</a> );
00658 
00659     irqReg &amp;= llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o9">irqEn</a>; <span class="comment">/* only consider bits where irq enabled */</span>
00660     <span class="keywordflow">if</span>( irqReg  )
00661     {
00662         <span class="keywordflow">if</span>( irqReg &amp; (<a class="code" href="z73__int_8h.html#a22">Z073_IRQ_PRS</a> | <a class="code" href="z73__int_8h.html#a21">Z073_IRQ_REL</a>) )
00663         {
00664             <span class="keywordflow">if</span>( (getStatusError = <a class="code" href="z73__int_8h.html#a37">getStatus</a>( llHdl )) )
00665             {
00666                 llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o17">error</a> = getStatusError;
00667                 <span class="comment">/* disable interrupts */</span>
00668                 MWRITE_D32( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o4">ma</a>, <a class="code" href="z73__int_8h.html#a11">Z073_IRQ_EN</a>, 0x00 );
00669                 IDBGWRT_ERR((<a class="code" href="z73__int_8h.html#a7">DBH</a>, <span class="stringliteral">"&gt;&gt;&gt;*** Z73_Irq: Queue Full, all interrupts disabled!!\n"</span>));
00670             }
00671 
00672             <span class="comment">/* if requested send signal to application */</span>
00673             <span class="keywordflow">if</span>( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o10">prsRelSig</a> ) {
00674                 OSS_SigSend( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o1">osHdl</a>, llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o10">prsRelSig</a> );
00675             }
00676             MWRITE_D32( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o4">ma</a>, <a class="code" href="z73__int_8h.html#a17">Z073_IRQ</a>, irqReg &amp;
00677                                              (<a class="code" href="z73__int_8h.html#a22">Z073_IRQ_PRS</a> | <a class="code" href="z73__int_8h.html#a21">Z073_IRQ_REL</a>) );
00678         } <span class="keywordflow">else</span>
00679         {
00680             <span class="comment">/* if requested send signal to application */</span>
00681             <span class="keywordflow">if</span>( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o11">upDwnSig</a> ) {
00682                 OSS_SigSend( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o1">osHdl</a>, llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o11">upDwnSig</a> );
00683             }
00684             MWRITE_D32( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o4">ma</a>, <a class="code" href="z73__int_8h.html#a17">Z073_IRQ</a>, irqReg &amp;
00685                                              (<a class="code" href="z73__int_8h.html#a24">Z073_IRQ_UP</a> | <a class="code" href="z73__int_8h.html#a23">Z073_IRQ_DWN</a>) );
00686         }
00687     } <span class="keywordflow">else</span>
00688     {
00689         <span class="keywordflow">return</span>( LL_IRQ_DEV_NOT );
00690     }
00691 
00692     llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o8">irqCount</a>++;
00693     <span class="keywordflow">return</span>(LL_IRQ_DEVICE);
00694 }
00695 
00696 <span class="comment">/****************************** Z73_Info ***********************************/</span>
<a name="l00734"></a><a class="code" href="z73__drv_8c.html#a11">00734</a> <span class="keyword">static</span> int32 <a class="code" href="z73__int_8h.html#a34">Z73_Info</a>(
00735    int32  infoType,
00736    ...
00737 )
00738 {
00739     int32   error = ERR_SUCCESS;
00740     va_list argptr;
00741 
00742     va_start(argptr, infoType );
00743 
00744     <span class="keywordflow">switch</span>(infoType) {
00745         <span class="comment">/*-------------------------------+</span>
00746 <span class="comment">        |  hardware characteristics      |</span>
00747 <span class="comment">        |  (all addr/data modes ORed)   |</span>
00748 <span class="comment">        +-------------------------------*/</span>
00749         <span class="keywordflow">case</span> LL_INFO_HW_CHARACTER:
00750         {
00751             u_int32 *addrModeP = va_arg(argptr, u_int32*);
00752             u_int32 *dataModeP = va_arg(argptr, u_int32*);
00753 
00754             *addrModeP = MDIS_MA08;
00755             *dataModeP = MDIS_MD08 | MDIS_MD16;
00756             <span class="keywordflow">break</span>;
00757         }
00758         <span class="comment">/*-------------------------------+</span>
00759 <span class="comment">        |  nr of required address spaces |</span>
00760 <span class="comment">        |  (total spaces used)           |</span>
00761 <span class="comment">        +-------------------------------*/</span>
00762         <span class="keywordflow">case</span> LL_INFO_ADDRSPACE_COUNT:
00763         {
00764             u_int32 *nbrOfAddrSpaceP = va_arg(argptr, u_int32*);
00765 
00766             *nbrOfAddrSpaceP = <a class="code" href="z73__int_8h.html#a3">ADDRSPACE_COUNT</a>;
00767             <span class="keywordflow">break</span>;
00768         }
00769         <span class="comment">/*-------------------------------+</span>
00770 <span class="comment">        |  address space type            |</span>
00771 <span class="comment">        |  (widest used data mode)       |</span>
00772 <span class="comment">        +-------------------------------*/</span>
00773         <span class="keywordflow">case</span> LL_INFO_ADDRSPACE:
00774         {
00775             u_int32 addrSpaceIndex = va_arg(argptr, u_int32);
00776             u_int32 *addrModeP = va_arg(argptr, u_int32*);
00777             u_int32 *dataModeP = va_arg(argptr, u_int32*);
00778             u_int32 *addrSizeP = va_arg(argptr, u_int32*);
00779 
00780             <span class="keywordflow">if</span> (addrSpaceIndex &gt;= <a class="code" href="z73__int_8h.html#a3">ADDRSPACE_COUNT</a>)
00781                 error = ERR_LL_ILL_PARAM;
00782             <span class="keywordflow">else</span> {
00783                 *addrModeP = MDIS_MA08;
00784                 *dataModeP = MDIS_MD16;
00785                 *addrSizeP = <a class="code" href="z73__int_8h.html#a4">ADDRSPACE_SIZE</a>;
00786             }
00787 
00788             <span class="keywordflow">break</span>;
00789         }
00790         <span class="comment">/*-------------------------------+</span>
00791 <span class="comment">        |   interrupt required           |</span>
00792 <span class="comment">        +-------------------------------*/</span>
00793         <span class="keywordflow">case</span> LL_INFO_IRQ:
00794         {
00795             u_int32 *useIrqP = va_arg(argptr, u_int32*);
00796 
00797             *useIrqP = <a class="code" href="z73__int_8h.html#a2">USE_IRQ</a>;
00798             <span class="keywordflow">break</span>;
00799         }
00800         <span class="comment">/*-------------------------------+</span>
00801 <span class="comment">        |   process lock mode            |</span>
00802 <span class="comment">        +-------------------------------*/</span>
00803         <span class="keywordflow">case</span> LL_INFO_LOCKMODE:
00804         {
00805             u_int32 *lockModeP = va_arg(argptr, u_int32*);
00806 
00807             *lockModeP = LL_LOCK_CALL;
00808             <span class="keywordflow">break</span>;
00809         }
00810         <span class="comment">/*-------------------------------+</span>
00811 <span class="comment">        |   (unknown)                    |</span>
00812 <span class="comment">        +-------------------------------*/</span>
00813         <span class="keywordflow">default</span>:
00814           error = ERR_LL_ILL_PARAM;
00815     }
00816 
00817     va_end(argptr);
00818     <span class="keywordflow">return</span>(error);
00819 }
00820 
00821 <span class="comment">/*******************************  Ident  ***********************************/</span>
<a name="l00826"></a><a class="code" href="z73__drv_8c.html#a12">00826</a> <span class="keyword">static</span> <span class="keywordtype">char</span>* <a class="code" href="z73__drv_8c.html#a12">Ident</a>( <span class="keywordtype">void</span> )
00827 {
00828     <span class="keywordflow">return</span>( (<span class="keywordtype">char</span>*) <a class="code" href="z73__drv_8c.html#a0">IdentString</a> );
00829 }
00830 
00831 <span class="comment">/********************************* Cleanup *********************************/</span>
<a name="l00841"></a><a class="code" href="z73__drv_8c.html#a13">00841</a> <span class="keyword">static</span> int32 <a class="code" href="z73__int_8h.html#a36">Cleanup</a>(
00842    <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a>    *llHdl,
00843    int32        retCode
00844 )
00845 {
00846     DBGWRT_1((<a class="code" href="z73__int_8h.html#a7">DBH</a>, <span class="stringliteral">"Z73 Cleanup: statusQ*=0x%08x   size=%d llHdl*=0x%08p\n"</span>,
00847      (u_int32 *)llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o12">statusQ</a>, (<span class="keywordtype">int</span>)llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o16">statusQSizeGot</a>, llHdl));
00848     <span class="comment">/*------------------------------+</span>
00849 <span class="comment">    |  close handles                |</span>
00850 <span class="comment">    +------------------------------*/</span>
00851     <span class="comment">/* clean up desc */</span>
00852     <span class="keywordflow">if</span> (llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o3">descHdl</a>)
00853         DESC_Exit(&amp;llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o3">descHdl</a>);
00854 
00855     <span class="comment">/* clean up debug */</span>
00856     DBGEXIT((&amp;<a class="code" href="z73__int_8h.html#a7">DBH</a>));
00857 
00858     <span class="comment">/*------------------------------+</span>
00859 <span class="comment">    |  free memory                  |</span>
00860 <span class="comment">    +------------------------------*/</span>
00861     <span class="comment">/* free status queue */</span>
00862     <span class="keywordflow">if</span>( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o12">statusQ</a> )
00863         OSS_MemFree(llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o1">osHdl</a>, (int8*)llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o12">statusQ</a>, llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o16">statusQSizeGot</a>);
00864 
00865     <span class="comment">/* free my handle */</span>
00866     OSS_MemFree(llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o1">osHdl</a>, (int8*)llHdl, llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o0">memAlloc</a>);
00867 
00868     <span class="comment">/*------------------------------+</span>
00869 <span class="comment">    |  return error code            |</span>
00870 <span class="comment">    +------------------------------*/</span>
00871     <span class="keywordflow">return</span>(retCode);
00872 }
00873 
<a name="l00874"></a><a class="code" href="z73__drv_8c.html#a14">00874</a> <span class="keyword">static</span> int32 <a class="code" href="z73__int_8h.html#a37">getStatus</a>( <a class="code" href="structLL__HANDLE.html">LL_HANDLE</a>* llHdl )
00875 {
00876     u_int32 retVal = 0;
00877     OSS_IRQ_STATE irqState;
00878     u_int32 curPosStat, curIrqStat;
00879     int32 error = ERR_SUCCESS;
00880 
00881     irqState = OSS_IrqMaskR( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o1">osHdl</a>, llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o2">irqHdl</a> );
00882 
00883     <span class="comment">/* detect full queue and abort if necessary */</span>
00884     <span class="keywordflow">if</span>( ( (llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o13">statusQIn</a> + 1) == llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o14">statusQOut</a>) ||
00885         (((llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o13">statusQIn</a> + 1) == llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o15">statusQDepth</a>) &amp;&amp;
00886          (llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o14">statusQOut</a> == 0)) )
00887     {
00888         error = Z073_ERR_STATUSQ_FULL;
00889         <span class="keywordflow">goto</span> ERR_EXIT;
00890     }
00891 
00892     curPosStat = MREAD_D32( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o4">ma</a>, <a class="code" href="z73__int_8h.html#a8">Z073_POS_CNT</a> );
00893     curIrqStat = MREAD_D32( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o4">ma</a>, <a class="code" href="z73__int_8h.html#a17">Z073_IRQ</a> );
00894 
00895     DBGWRT_1((<a class="code" href="z73__int_8h.html#a7">DBH</a>, <span class="stringliteral">"Z73 getStatus: curPosStat=0x%08X\n"</span>,curPosStat));
00896 
00897     retVal |= (curIrqStat &amp; <a class="code" href="z73__int_8h.html#a22">Z073_IRQ_PRS</a>) ? Z073_STATUS_PRS : 0;
00898     retVal |= (curIrqStat &amp; <a class="code" href="z73__int_8h.html#a21">Z073_IRQ_REL</a>) ? Z073_STATUS_REL : 0;
00899     retVal |= (curPosStat &amp; <a class="code" href="z73__int_8h.html#a9">Z073_POS_CNT_STS</a>) ? (Z073_STATUS_MOV |
00900                                                 (curPosStat &amp; <a class="code" href="z73__int_8h.html#a10">Z073_POS_CNT_CNT</a>))
00901                                               : 0;
00902 
00903     <span class="comment">/* also get current status of inputs for debug purposes ? */</span>
00904     retVal |= curIrqStat&amp;(<a class="code" href="z73__int_8h.html#a18">Z073_IRQ_STS_PRSREL</a>|<a class="code" href="z73__int_8h.html#a20">Z073_IRQ_STS_B</a>|<a class="code" href="z73__int_8h.html#a19">Z073_IRQ_STS_A</a>)&lt;&lt;24;
00905 
00906     <span class="comment">/* place in Q, one field will never get filled, otherwise more flags are</span>
00907 <span class="comment">     * needed to detect full queue */</span>
00908     <span class="keywordflow">if</span>( retVal &amp; (Z073_STATUS_PRS | Z073_STATUS_REL | Z073_STATUS_MOV) )
00909         llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o12">statusQ</a>[llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o13">statusQIn</a>++] = retVal;
00910 
00911     <span class="keywordflow">if</span>( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o13">statusQIn</a> == llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o15">statusQDepth</a> )
00912         llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o13">statusQIn</a> = 0;
00913 
00914     <span class="comment">/* status reported, clear bits */</span>
00915     MWRITE_D32(llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o4">ma</a>, <a class="code" href="z73__int_8h.html#a17">Z073_IRQ</a>, <a class="code" href="z73__int_8h.html#a22">Z073_IRQ_PRS</a> | <a class="code" href="z73__int_8h.html#a21">Z073_IRQ_REL</a> |
00916                                     <a class="code" href="z73__int_8h.html#a24">Z073_IRQ_UP</a>  | <a class="code" href="z73__int_8h.html#a24">Z073_IRQ_UP</a> );
00917 
00918 ERR_EXIT:
00919     OSS_IrqRestore( llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o1">osHdl</a>, llHdl-&gt;<a class="code" href="structLL__HANDLE.html#o2">irqHdl</a>, irqState );
00920     <span class="keywordflow">return</span>( error );
00921 }
00922 
00923 
</pre></div>
	</div>
</div>

<div class="footer">
<!-- Footer -->
	<p class="footer">
	Generated for Z73 MDIS Driver using <a href="http://www.doxygen.org">doxygen</a>. All Rights Reserved.
	</p>
</div>

</body>
</html>

